# MarioNetDevice における外部アプリケーションインターフェイス

## 概要

MarioNetDeviceでは端末固有の制御などを外部アプリケーションで行えるようにしています。
インターフェイスはZeroMQを通じて提供されるため、MQTT通信部分やGPIO、PLCを扱う部分はMarioNetDevice本体にまかせ、外部アプリケーション側では言語やフレームワークの種類に依存する事なく各種イベントの受信、コマンドの発行を用いてシステムを構築する事が可能です。

外部アプリケーションにはZeroMQを通して次の２つのイベントが転送されます。

* MQTT Subscribeイベント
* GPIO,PLCなどのアナログ・デジタルI/Oイベント

また、外部アプリケーション側からMarioNetDeviceに対してGPIO出力やMQTT Publishなどのコマンドを発行する事ができます。

## Subscribeイベントの待機

### MarioNetDeviceの提供するZeroMQポートへのconnect

外部アプリケーションからMarioNetDeviceのイベントを受け取るには、ZeroMQポートにconnectする必要が有ります。connectする為に必要な情報は下記の通りです。

* ZMQ Endopoint
    * tcp://127.0.0.1:6788

### Subscribe

MarioNetDeivce側から送られてくるデータのフォーマットは以下の通りです。
データフォーマットは5つのパートに分かれ、各パートは":@:"で区切られます。

__ [イベント種別]:@:[送信元デバイスID]:@:[データ種別]:@:[データ番号]:@:[ペイロード] __

**********************************************

イベント種別は以下の2種類です。

* I/Oイベント: "io"
* Subscribeイベント: "sub"

**********************************************

データ種別は以下の２種類です。

* デジタルデータ: "digital"
* アナログデータ: "analog"

**********************************************

データ番号は、受信データの送信元デバイス内でデータに割り振られた番号です。例としてアナログ0番目の場合は通常"0"となります。

また、デジタル信号の場合は8点毎に割り振られたデジタルポート番号となります。
例として、デジタル0番目から7番目までのデータは、”ポート0”のデータとして[0,0,0,1,1,1,0,1]のように8点分のデジタルビットの配列として送られます。

**********************************************

ペイロードは各種データの実際の値、および付帯情報をJSONフォーマットで表現したものです。
フォーマットはデータ種別毎に異なります。

アナログデータ
```json
{
  "type": "ai",         // ai固定
  "id": "my-deivce-id", // デバイスID
  "no": 2,              // アナログ番号
  "val": 521            // アナログ値
}
```

デジタルデータ
```json
{
  "type": "di",               // di固定
  "id": "my-deivce-id",       // デバイスID
  "no": 2,                    // デジタルポート番号
  "status": [0,0,0,1,1,1,0,1] // アナログ値
}
```
